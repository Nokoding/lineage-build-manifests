name: LineageOS 16.0 Build for gts210vewifi

on:
  workflow_dispatch: # Allows manual trigger
  push:
    branches:
      - main

jobs:
  build:
    # Use the Ubuntu 22.04 runner
    runs-on: ubuntu-22.04
    
    steps:
      # 1. Checkout your manifest repository
      - name: Checkout Manifest Repository
        uses: actions/checkout@v4
        with:
          repository: Nokoding/lineage-build-manifests
          ref: main

      # 2. FIX: Install Dependencies and Manually set up Python 2
      - name: Install Build Dependencies and Python 2
        run: |
          echo "Installing build dependencies..."
          sudo apt-get clean
          sudo dpkg --configure -a
          
          # Install deps from wiki, replacing 'python-is-python2' with 'python2'
          sudo apt install -y \
            bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git-lfs gnupg gperf imagemagick \
            protobuf-compiler python3-protobuf lib32readline-dev \
            lib32z1-dev libdw-dev libelf-dev lz4 libsdl1.2-dev \
            libssl-dev libxml2 libxml2-utils lzop pngcrush rsync \
            schedtool squashfs-tools xsltproc zip zlib1g-dev \
            lib32ncurses5-dev libncurses5 libncurses5-dev \
            python2 # <-- This package provides /usr/bin/python2

          # FIX: Manually link /usr/bin/python to python2
          # This replaces the functionality of the missing 'python-is-python2' package
          sudo ln -sf /usr/bin/python2 /usr/bin/python
          
          # Verify the python version to be sure
          echo "Verifying python version:"
          python --version

      # 3. FIX: Install 'repo' tool using the secure $GITHUB_PATH
      - name: Install Repo Tool
        run: |
          echo "Setting up 'repo' utility..."
          mkdir -p "${HOME}/.bin"
          echo "${HOME}/.bin" >> $GITHUB_PATH
          curl 'https://storage.googleapis.com/git-repo-downloads/repo' -o "${HOME}/.bin/repo"
          chmod a+x "${HOME}/.bin/repo"
          
          # Configure git (as required by repo init)
          git config --global user.email "you@example.com"
          git config --global user.name "Your Name"
          git config --global trailer.changeid.key "Change-Id"
          git lfs install

      # 4. FIX: Initialize Repository (using wiki's exact command)
      - name: Initialize LineageOS Repository
        run: |
          echo "Initializing source repository..."
          mkdir -p lineage
          cd lineage
          
          # Use the exact command from the LineageOS 16.0 guide
          repo init -u https://github.com/LineageOS/android.git -b lineage-16.0 --git-lfs --no-clone-bundle
          
          # Copy your local_manifests.xml for the vendor blobs
          mkdir -p ./.repo/local_manifests/
          cp ../local_manifests.xml ./.repo/local_manifests/

      # 5. FIX: Sync the Source Code (removed unsupported flag)
      - name: Repo Sync
        run: |
          echo "Starting repo sync..."
          cd lineage
          repo sync --force-sync --jobs=4 --no-clone-bundle

      # 6. FIX: Run 'breakfast' (replaces 'lunch')
      - name: Prepare Device-Specific Code
        run: |
          echo "Running breakfast..."
          cd lineage
          source build/envsetup.sh
          # This command downloads the device tree and kernel
          breakfast gts210vewifi

      # 7. FIX: Run 'brunch' (replaces 'mka bacon')
      - name: Start Build
        run: |
          echo "Starting brunch..."
          cd lineage
          source build/envsetup.sh
          # This is the final build command from the guide
          brunch gts210vewifi

      # 8. Upload the final ZIP file
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lineage-16.0-gts210vewifi-zip
          path: lineage/out/target/product/gts210vewifi/lineage-*.zip
