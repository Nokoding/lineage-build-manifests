name: LineageOS Build Job

on:
  workflow_dispatch: # Allows manual trigger
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    # Use the Ubuntu 22.04 runner
    runs-on: ubuntu-22.04
    
    steps:
      # 1. Checkout the manifest repository (Nokoding/lineage-build-manifests)
      - name: Checkout Manifest Repository
        uses: actions/checkout@v4
        with:
          repository: Nokoding/lineage-build-manifests
          ref: main
          fetch-depth: 0 

      # 2. FIX: Install Build Dependencies (Resolves Git Conflict)
      - name: Install Build Dependencies (Fixed)
        run: |
          echo "Installing build dependencies..."
          # Clean up any potential broken package state
          sudo apt-get clean
          sudo dpkg --configure -a
          
          # Install tools (NOTE: 'git' is REMOVED from this list)
          sudo apt install -y \
            bc bison build-essential ccache curl flex g++-multilib \
            imagemagick gnupg gperf lib32ncurses5-dev lib32readline-dev \
            lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev \
            libssl-dev libxml2 libxml2-utils lzop pngcrush rsync \
            schedtool squashfs-tools xsltproc zip zlib1g-dev

      # 3. FIX: Install and Setup 'repo' Tool (Uses $GITHUB_PATH to fix 'command not found')
      - name: Install Repo Tool
        run: |
          echo "Setting up 'repo' utility with Environment File..."
          # 1. Create the local bin directory
          mkdir -p "${HOME}/.bin"
          
          # 2. Add the directory to the GitHub Actions PATH for all subsequent steps (SECURE METHOD)
          echo "${HOME}/.bin" >> $GITHUB_PATH
          
          # 3. Download the repo utility and make it executable
          curl 'https://storage.googleapis.com/git-repo-downloads/repo' -o "${HOME}/.bin/repo"
          chmod a+x "${HOME}/.bin/repo"

      # 4. Initialize the Source Repository
      - name: Initialize LineageOS Repository
        run: |
          echo "Initializing source repository..."
          # Create the main working directory for the source code
          mkdir -p lineage
          cd lineage
          
          # Initialize the LineageOS 16.0 tree
          repo init -u https://github.com/LineageOS/android.git -b lineage-16.0
          
          # Prepare the local manifests directory and copy the file
          mkdir -p ./.repo/local_manifests/
          cp ../local_manifests.xml ./.repo/local_manifests/

      # 5. FIX: Sync the Source Code (Removed unsupported '--fail-on-missing' flag)
      - name: Repo Sync (Fixed)
        run: |
          echo "Starting repo sync..."
          cd lineage
          # Sync using multiple jobs (j4)
          repo sync --force-sync --jobs=4 --no-clone-bundle

      # 6. Build Preparation (Next Steps)
      # These steps are placeholdersâ€”replace comments with your specific device commands
      - name: Environment Setup
        run: |
          echo "Setting up build environment..."
          cd lineage
          source build/envsetup.sh
          # TODO: Add your 'lunch' command here (e.g., lunch lineage_jfltexx-userdebug)

      # 7. Start the Build (Final Step)
      - name: Start Build
        run: |
          echo "Starting device build (example)..."
          cd lineage
          # TODO: Add your 'make' command here (e.g., mka bacon)
