name: LineageOS 16.0 Build for gts210vewifi

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      # 1. Checkout your manifest repository
      - name: Checkout Manifest Repository
        uses: actions/checkout@v4
        with:
          repository: Nokoding/lineage-build-manifests
          ref: main

      # 2. FIX: Install Dependencies and Manually set up Python 2
      - name: Install Build Dependencies and Python 2
        run: |
          echo "Installing build dependencies..."
          sudo apt-get clean
          sudo dpkg --configure -a
          
          # Install tools and Python 2
          sudo apt install -y \
            bc bison build-essential ccache curl flex g++-multilib \
            gcc-multilib git-lfs gnupg gperf imagemagick \
            protobuf-compiler python3-protobuf lib32readline-dev \
            lib32z1-dev libdw-dev libelf-dev lz4 libsdl1.2-dev \
            libssl-dev libxml2 libxml2-utils lzop pngcrush rsync \
            schedtool squashfs-tools xsltproc zip zlib1g-dev \
            lib32ncurses5-dev libncurses5 libncurses5-dev \
            python2
          sudo ln -sf /usr/bin/python2 /usr/bin/python

      # 3. SETUP: Configure CCACHE and Clean up
      - name: Set up CCACHE and Clean Disk Space
        run: |
          # Configure ccache
          export USE_CCACHE=1
          export CCACHE_EXEC=/usr/bin/ccache
          
          # Set a tight limit for ccache storage (5GB max)
          ccache -M 5G 
          echo "CCACHE configured with 5GB limit."
          
          # Clean up any cached packages or large temporary files
          sudo apt-get autoremove -y
          sudo apt-get clean
          sudo rm -rf /usr/share/dotnet
          
          # Display disk space after cleanup (optional, for debugging)
          df -h

      # 4. FIX: Install 'repo' tool using the secure $GITHUB_PATH
      - name: Install Repo Tool
        run: |
          echo "Setting up 'repo' utility..."
          mkdir -p "${HOME}/.bin"
          echo "${HOME}/.bin" >> $GITHUB_PATH
          curl 'https://storage.googleapis.com/git-repo-downloads/repo' -o "${HOME}/.bin/repo"
          chmod a+x "${HOME}/.bin/repo"
          
          # Configure git
          git config --global user.email "you@example.com"
          git config --global user.name "Your Name"
          git config --global trailer.changeid.key "Change-Id"
          git lfs install

      # 5. Initialize Repository
      - name: Initialize LineageOS Repository
        run: |
          echo "Initializing source repository..."
          mkdir -p lineage
          cd lineage
          
          # Use the wiki's exact command
          repo init -u https://github.com/LineageOS/android.git -b lineage-16.0 --git-lfs --no-clone-bundle
          
          # Copy your local_manifests.xml for the vendor blobs
          mkdir -p ./.repo/local_manifests/
          cp ../local_manifests.xml ./.repo/local_manifests/

      # 6. Sync the Source Code
      - name: Repo Sync (This is the high-risk step)
        run: |
          echo "Starting repo sync..."
          cd lineage
          repo sync --force-sync --jobs=4 --no-clone-bundle

      # 7. Run 'breakfast'
      - name: Prepare Device-Specific Code
        run: |
          echo "Running breakfast..."
          cd lineage
          source build/envsetup.sh
          breakfast gts210vewifi

      # 8. Run 'brunch'
      - name: Start Build
        run: |
          echo "Starting brunch..."
          cd lineage
          source build/envsetup.sh
          brunch gts210vewifi

      # 9. Upload the final ZIP file
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: lineage-16.0-gts210vewifi-zip
          path: lineage/out/target/product/gts210vewifi/lineage-*.zip
